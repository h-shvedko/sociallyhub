// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// CORE ENTITIES
// ========================================

model Workspace {
  id        String   @id @default(cuid())
  name      String
  timezone  String   @default("UTC")
  branding  Json?    // Store workspace branding (logo, colors, etc.)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users          UserWorkspace[]
  clients        Client[]
  socialAccounts SocialAccount[]
  posts          Post[]
  campaigns      Campaign[]
  assets         Asset[]
  templates      Template[]
  inboxItems     InboxItem[]
  auditEvents    AuditEvent[]

  @@map("workspaces")
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  emailVerified DateTime?
  name          String?
  image         String?
  password      String?
  twoFactorEnabled Boolean @default(false)
  timezone      String?  @default("UTC")
  locale        String?  @default("en")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  workspaces      UserWorkspace[]
  accounts        Account[]
  sessions        Session[]
  assignedInboxItems InboxItem[] @relation("AssignedTo")
  notifications   Notification[]
  auditEvents     AuditEvent[]
  createdPosts    Post[]
  approvedPosts   Post[] @relation("ApprovedBy")

  @@map("users")
}

model UserWorkspace {
  id          String      @id @default(cuid())
  userId      String
  workspaceId String
  role        WorkspaceRole
  permissions Json        // Store granular permissions
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
  @@map("user_workspaces")
}

model Client {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  labels      String[] // Tags for client organization
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace      Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  socialAccounts SocialAccount[]
  posts          Post[]
  campaigns      Campaign[]

  @@map("clients")
}

model SocialAccount {
  id           String              @id @default(cuid())
  workspaceId  String
  clientId     String?
  provider     SocialProvider
  accountType  String              // "page", "profile", "channel", etc.
  handle       String              // @username or page name
  displayName  String
  accountId    String              // Provider's account ID
  accessToken  String              // Encrypted
  refreshToken String?             // Encrypted
  tokenExpiry  DateTime?
  scopes       String[]            // What permissions we have
  status       SocialAccountStatus @default(ACTIVE)
  metadata     Json?               // Provider-specific data
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  workspace    Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  client       Client?       @relation(fields: [clientId], references: [id], onDelete: SetNull)
  postVariants PostVariant[]
  inboxItems   InboxItem[]
  metrics      AnalyticsMetric[]

  @@unique([provider, accountId, workspaceId])
  @@map("social_accounts")
}

// ========================================
// CONTENT & PUBLISHING
// ========================================

model Post {
  id          String     @id @default(cuid())
  workspaceId String
  clientId    String?
  title       String?
  baseContent String?    // Master content before platform customization
  link        String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  campaignId  String?
  tags        String[]
  status      PostStatus @default(DRAFT)
  ownerId     String     // User who created the post
  approverId  String?    // User who approved (if approval required)
  scheduledAt DateTime?
  publishedAt DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  workspace    Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  client       Client?       @relation(fields: [clientId], references: [id], onDelete: SetNull)
  owner        User          @relation(fields: [ownerId], references: [id])
  approver     User?         @relation("ApprovedBy", fields: [approverId], references: [id])
  campaign     Campaign?     @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  variants     PostVariant[]
  assets       PostAsset[]
  metrics      AnalyticsMetric[]

  @@map("posts")
}

model PostVariant {
  id              String         @id @default(cuid())
  postId          String
  socialAccountId String
  text            String?
  hashtags        String[]
  platformData    Json?          // Platform-specific fields (YouTube title, etc.)
  status          VariantStatus  @default(PENDING)
  providerPostId  String?        // ID from the social platform after publishing
  publishedAt     DateTime?
  failureReason   String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  post          Post          @relation(fields: [postId], references: [id], onDelete: Cascade)
  socialAccount SocialAccount @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)

  @@unique([postId, socialAccountId])
  @@map("post_variants")
}

model PostAsset {
  id      String @id @default(cuid())
  postId  String
  assetId String

  post  Post  @relation(fields: [postId], references: [id], onDelete: Cascade)
  asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([postId, assetId])
  @@map("post_assets")
}

model Asset {
  id           String    @id @default(cuid())
  workspaceId  String
  filename     String
  originalName String
  mimeType     String
  size         Int       // File size in bytes
  url          String    // Storage URL
  thumbnailUrl String?   // Thumbnail for videos/images
  width        Int?      // Image/video width
  height       Int?      // Image/video height
  duration     Float?    // Video duration in seconds
  metadata     Json?     // EXIF, transcoding status, etc.
  tags         String[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  workspace Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  posts     PostAsset[]

  @@map("assets")
}

model Template {
  id          String       @id @default(cuid())
  workspaceId String
  name        String
  description String?
  content     String       // Template content with variables
  variables   String[]     // List of variables like ["product", "url"]
  type        TemplateType @default(POST)
  isGlobal    Boolean      @default(false) // Global vs personal templates
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@map("templates")
}

model Campaign {
  id          String   @id @default(cuid())
  workspaceId String
  clientId    String?
  name        String
  description String?
  startDate   DateTime?
  endDate     DateTime?
  objectives  Json?    // Campaign goals and KPIs
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  client    Client?   @relation(fields: [clientId], references: [id], onDelete: SetNull)
  posts     Post[]

  @@map("campaigns")
}

// ========================================
// INBOX & CONVERSATIONS
// ========================================

model InboxItem {
  id               String         @id @default(cuid())
  workspaceId      String
  socialAccountId  String
  type             InboxItemType
  providerThreadId String?        // Thread ID from social platform
  providerItemId   String         // Comment/message ID from platform
  content          String
  authorName       String?
  authorHandle     String?
  authorAvatar     String?
  sentiment        String?        // "positive", "negative", "neutral"
  status           InboxStatus    @default(OPEN)
  assigneeId       String?        // Assigned team member
  tags             String[]
  internalNotes    String?
  slaBreachedAt    DateTime?      // When SLA was breached
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  workspace     Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  socialAccount SocialAccount @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)
  assignee      User?         @relation("AssignedTo", fields: [assigneeId], references: [id], onDelete: SetNull)
  conversation  Conversation?

  @@unique([providerItemId, socialAccountId])
  @@map("inbox_items")
}

model Conversation {
  id          String @id @default(cuid())
  inboxItemId String @unique
  threadData  Json?  // Full conversation thread from platform

  inboxItem InboxItem @relation(fields: [inboxItemId], references: [id], onDelete: Cascade)

  @@map("conversations")
}

// ========================================
// ANALYTICS & METRICS
// ========================================

model AnalyticsMetric {
  id              String   @id @default(cuid())
  workspaceId     String   // For workspace-level filtering
  socialAccountId String?  // Account-specific metrics
  postId          String?  // Post-specific metrics
  date            DateTime @db.Date
  hour            Int?     // Hour of day (0-23) for hourly metrics
  platform        SocialProvider
  metricType      String   // "impressions", "reach", "likes", "comments", etc.
  value           Float
  dimensions      Json?    // Additional dimensions (campaign, post_type, etc.)
  createdAt       DateTime @default(now())

  socialAccount SocialAccount? @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)
  post          Post?          @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([socialAccountId, postId, date, hour, metricType])
  @@index([workspaceId, date])
  @@index([postId, metricType])
  @@map("analytics_metrics")
}

// ========================================
// SYSTEM & NOTIFICATIONS
// ========================================

model Notification {
  id          String             @id @default(cuid())
  userId      String
  type        NotificationType
  title       String
  message     String
  data        Json?              // Additional notification data
  status      NotificationStatus @default(UNREAD)
  deliveredAt DateTime?
  readAt      DateTime?
  createdAt   DateTime           @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model AuditEvent {
  id          String   @id @default(cuid())
  workspaceId String
  userId      String?  // Can be null for system events
  action      String   // "create", "update", "delete", "publish", etc.
  resource    String   // "post", "account", "user", etc.
  resourceId  String?  // ID of the affected resource
  oldValues   Json?    // Previous state
  newValues   Json?    // New state
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([workspaceId, createdAt])
  @@index([userId, createdAt])
  @@map("audit_events")
}

// ========================================
// NEXT-AUTH MODELS
// ========================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ========================================
// ENUMS
// ========================================

enum WorkspaceRole {
  OWNER
  ADMIN
  PUBLISHER
  ANALYST
  CLIENT_VIEWER
}

enum SocialProvider {
  TWITTER
  FACEBOOK
  INSTAGRAM
  LINKEDIN
  YOUTUBE
  TIKTOK
}

enum SocialAccountStatus {
  ACTIVE
  TOKEN_EXPIRED
  REVOKED
  ERROR
}

enum PostStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  SCHEDULED
  PUBLISHED
  FAILED
  CHANGES_REQUESTED
  ARCHIVED
}

enum VariantStatus {
  PENDING
  SCHEDULED
  PUBLISHED
  FAILED
}

enum InboxItemType {
  COMMENT
  MENTION
  DIRECT_MESSAGE
  REVIEW
  REPLY
}

enum InboxStatus {
  OPEN
  ASSIGNED
  SNOOZED
  CLOSED
}

enum TemplateType {
  POST
  RESPONSE
}

enum NotificationType {
  APPROVAL_REQUESTED
  APPROVAL_GRANTED
  APPROVAL_DENIED
  PUBLISH_SUCCESS
  PUBLISH_FAILED
  TOKEN_EXPIRING
  TOKEN_EXPIRED
  INBOX_ASSIGNMENT
  SLA_BREACH
  REPORT_READY
}

enum NotificationStatus {
  UNREAD
  READ
  DISMISSED
}
